<!DOCTYPE html>
<html lang="bo">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>པཎྜི་ཏ། >> ཧི་མ་ལ་ཡ།</title>
  <style>
    @font-face { font-family: 'BZDHT'; src: url('./BZDHT.ttf') format('truetype'); }
    @font-face { font-family: 'WildYak'; src: url('./TibetWildYak.ttf') format('truetype'); }

    :root { --primary-red: #8B0000; --bg: #f2f2f7; --card: #ffffff; --radius: 20px; }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); overflow: hidden; }

    body {
      font-family: 'WildYak', -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    .title-area, .toolbar-card, .footer-area {
      -webkit-user-select: none !important;
      user-select: none !important;
      -webkit-touch-callout: none !important;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      padding: env(safe-area-inset-top) 12px calc(env(safe-area-inset-bottom) + 25px);
      gap: 6px;
    }

    .title-area { flex: 0 0 auto; padding: 2px 0; text-align: center; }
    .title-area h1 { font-size: clamp(14px, 4.5vw, 22px); color: var(--primary-red); margin: 0; font-family: 'WildYak'; }

    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      gap: 6px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid #d1d1d6;
      border-top: 6px solid var(--primary-red);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 8px;
    }

    .main-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
      overflow: hidden;
    }

    .areas { display: flex; flex-direction: column; gap: 6px; flex: 1; min-height: 0; }
    .area { flex: 1 1 0; display: flex; flex-direction: column; min-height: 0; min-width: 0; }
    .area h2 { font-size: 11px; color: var(--primary-red); margin: 0 0 2px 0; font-family: 'WildYak'; }

    .view-common {
      flex: 1; width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e5e5ea;
      outline: none; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; 
      min-height: 0; -webkit-overflow-scrolling: touch; position: relative;
    }

    #inputView { 
      background: #fafafa;
      font-size: 12.8px; 
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Noto Sans CJK SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
      line-height: 2.53; 
      -webkit-user-select: text !important;
      user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      -webkit-touch-callout: default !important;
      touch-action: auto;
    }
    #inputView .bzd { font-family: 'BZDHT', sans-serif !important; }
    #inputView .han { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Noto Sans CJK SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif !important; }
    #inputView .other { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Noto Sans CJK SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif !important; }
    
    #inputView:empty:before { 
      content: attr(data-placeholder); 
      color: #999; 
      font-family: 'WildYak', serif; 
      font-size: 18px; 
      position: absolute;
      pointer-events: none;
    }
    #inputView:focus:empty:before { display: none; }

    #outputView { 
      background: #ffffff;
      font-family: 'WildYak', sans-serif !important; 
      font-size: 18.8px; 
      line-height: 1.782;
      color: #000;
      user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      -webkit-touch-callout: default !important;
      touch-action: auto;
      pointer-events: auto;
      cursor: text;
    }

    #outputView:empty:before { 
      content: attr(data-placeholder); 
      color: #999; 
      font-family: 'WildYak', serif; 
      font-size: 18px; 
      position: absolute;
      pointer-events: none;
    }

    .toolbar-card { 
      flex: 0 0 auto; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      gap: 15px; 
      padding: 8px 0; 
      width: 100%;
    }
    .toolbar-inner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 0 auto;
      width: max-content;
      max-width: 100%;
    }
    .btn { padding: 6px 20px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; font-family: 'WildYak'; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .btn-clear { background: #e5e5ea; color: #3a3a3c; }
    .btn-copy { background: var(--primary-red); color: white; }
    .btn svg { width: 18px; height: 18px; fill: currentColor; }
    /* 按钮闪烁反馈 */
    .btn.flash { animation: btnFlash .35s ease; }
    @keyframes btnFlash {
      0% { filter: none; transform: none; }
      30% { filter: brightness(1.35); transform: translateY(0.5px); }
      60% { filter: brightness(1.0); transform: none; }
      100% { filter: none; transform: none; }
    }

    .footer-area {
      flex: 0 0 auto;
      text-align: center;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(209, 209, 214, 0.4);
      margin-bottom: 5px;
    }

    .footer-area .disclaimer { color: var(--primary-red); font-size: 9px; line-height: 1.3; margin-bottom: 2px; font-family: sans-serif; }
    .footer-area .copyright { color: #007AFF; font-size: 9px; font-family: 'WildYak', serif; font-weight: bold; }

    @media (orientation: landscape) {
      .areas { flex-direction: row; }
      .title-area h1 { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="title-area">
      <h1>ཁམས་པ་ཚངབོད་ཡིག་ཨང་བསྒྱུར། • པཎྜི་ཏ། >> ཧི་མ་ལ་ཡ།</h1>
    </div>

    <div class="main-container">
      <div class="card main-card">
        <div class="areas">
          <section class="area">
            <h2>འགོད་འཇུག་ཁུལ།（པཎྜི་ཏ།）</h2>
            <textarea id="input" style="display:none !important;"></textarea>
            <div id="inputView" class="view-common" contenteditable="true" data-placeholder="པཎྜི་ཏའི་ནང་དོན་འདི་ན་འགོད་རོགས།..."></div>
          </section>
          <section class="area">
            <h2>མཇུག་འབྲས་ཁུལ།（ཧི་མ་ལ་ཡ།）</h2>
            <textarea id="output" style="display:none !important;"></textarea>
            <div id="outputView" class="view-common" data-placeholder="བསྒྱུར་ཟིན་ཧི་ཡིག་འདི་ནས་འཆར་འོང་།"></div>
          </section>
        </div>
      </div>

      <div class="card toolbar-card">
        <div class="toolbar-inner">
          <button id="clearBtn" class="btn btn-clear">
            གཙང་སེལ་བཟོ།
            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>
          <button id="copyBtn" class="btn btn-copy">
            ཆ་ཚང་བཤུ།
            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="footer-area">
      <div class="disclaimer">
        免责声明：本软件按“现状”（AS IS）提供，仅限班智达与喜马拉雅藏文的编码转换。开发者不提供任何明示或暗示担保，亦不承担因使用本工具产生的任何直接或间接损失及法律责任。<br>
        <span style="color: #ff3b30; font-weight: bold;">⚠️ 注意：班智达原文中不得夹杂中文，否则会导致乱码！</span>
      </div>
      <div class="copyright">© ༢༠༢༦ ཁམས་པ་ཚང་། KHAM PA TSANG ༡༧༧༡༡༩༥༥༥༥༤</div>
    </div>
  </div>

  <script src="./rules_data.js"></script>
  <script src="./converter.js?v=202602222055"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const el = document.getElementById('inputView');
      const hiddenInput = document.getElementById('input');
      const hiddenOutput = document.getElementById('output');
      const viewOutput = document.getElementById('outputView');
      const allowAreas = [el, viewOutput];
      let allowProgrammaticCopy = false;
      
      let isComposing = false;

      function syncOutput() {
        if (!(hiddenOutput && viewOutput)) return;
        const nextText = hiddenOutput.value || '';
        const nowText = viewOutput.innerText || '';
        if (nowText === nextText) return;
        // 若当前选区在输出区内，暂不刷新，避免打断选择
        try {
          const sel = window.getSelection && window.getSelection();
          if (sel && sel.rangeCount > 0) {
            const within = (node) => {
              let n = (node && node.nodeType === 3) ? node.parentNode : node;
              while (n) { if (n === viewOutput) return true; n = n.parentNode; }
              return false;
            };
            for (let i = 0; i < sel.rangeCount; i++) {
              const r = sel.getRangeAt(i);
              if (within(r.startContainer) || within(r.endContainer)) return;
            }
          }
        } catch(_) {}
        viewOutput.innerText = nextText;
      }
      function rootAllowed(node){
        let n = (node.nodeType === 3) ? node.parentNode : node;
        while (n) {
          if (allowAreas.includes(n)) return n;
          n = n.parentNode;
        }
        return null;
      }
      function rangeWithinAllowed(range){
        const sr = rootAllowed(range.startContainer);
        const er = rootAllowed(range.endContainer);
        return !!(sr && er && sr === er);
      }
      document.addEventListener('copy', (e) => {
        if (allowProgrammaticCopy) { allowProgrammaticCopy = false; return; }
        const sel = window.getSelection && window.getSelection();
        let ok = false;
        if (sel && sel.rangeCount > 0) {
          ok = true;
          for (let i = 0; i < sel.rangeCount; i++) {
            if (!rangeWithinAllowed(sel.getRangeAt(i))) { ok = false; break; }
          }
        }
        if (!ok) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);

      function getCaretOffset(container){
        const sel = window.getSelection();
        if (!sel || sel.rangeCount===0) return 0;
        const range = sel.getRangeAt(0);
        const pre = range.cloneRange();
        pre.selectNodeContents(container);
        pre.setEnd(range.endContainer, range.endOffset);
        return pre.toString().length;
      }
      function setCaretOffset(container, offset){
        const sel = window.getSelection();
        const range = document.createRange();
        let current = 0;
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null);
        let node;
        while ((node = walker.nextNode())) {
          const next = current + node.nodeValue.length;
          if (offset <= next) {
            range.setStart(node, Math.max(0, offset - current));
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            return;
          }
          current = next;
        }
        range.selectNodeContents(container);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
      }
      function decorateText(text, whiteList){
        let html = '';
        let runCls = null;
        let runBuf = '';
        const flush = () => {
          if (!runBuf) return;
          if (runCls === 'br') { html += '<br>'; }
          else {
            html += '<span class="'+runCls+'">'+runBuf.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</span>';
          }
          runBuf = ''; runCls = null;
        };
        for (const ch of text){
          if (ch === '\\n'){ flush(); runCls = 'br'; runBuf = '\\n'; flush(); continue; }
          const isMapped = Object.prototype.hasOwnProperty.call(whiteList, ch);
          const cp = ch.codePointAt(0);
          const isCJK = cp && ((cp>=0x4E00 && cp<=0x9FFF) || (cp>=0x3400 && cp<=0x4DBF));
          const cls = isMapped ? 'bzd' : (isCJK ? 'han' : 'other');
          if (cls !== runCls) { flush(); runCls = cls; runBuf = ch; }
          else { runBuf += ch; }
        }
        flush();
        return html;
      }
      function handleInput() {
        if (isComposing) return;
        const whiteList = (window.RULES_DATA && window.RULES_DATA.rules) ? window.RULES_DATA.rules : {};
        const caret = getCaretOffset(el);
        const originalText = el.innerText;
        let resultText = "";
        for (let char of originalText) {
          const code = char.charCodeAt(0);
          if (code >= 0x4E00 && code <= 0x9FA5) {
            if (Object.prototype.hasOwnProperty.call(whiteList, char)) {
              resultText += char;
            }
          } else {
            resultText += char;
          }
        }
        el.innerHTML = decorateText(resultText, whiteList);
        setCaretOffset(el, Math.min(caret, resultText.length));
        if (hiddenInput) {
          hiddenInput.value = resultText;
          hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
          if (window.__runConvert) { window.__runConvert(); }
        }
        setTimeout(()=>{ syncOutput(); }, 20);
      }

      el.addEventListener('compositionstart', () => { isComposing = true; });
      el.addEventListener('compositionend', () => { 
        isComposing = false; 
        handleInput(); 
      });

      el.addEventListener('input', handleInput);

      el.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        const whiteList = (window.RULES_DATA && window.RULES_DATA.rules) ? window.RULES_DATA.rules : {};
        let cleanText = "";
        for (let char of text) {
          const code = char.charCodeAt(0);
          if (code >= 0x4E00 && code <= 0x9FA5) {
            if (Object.prototype.hasOwnProperty.call(whiteList, char)) cleanText += char;
          } else { cleanText += char; }
        }
        document.execCommand('insertText', false, cleanText);
        requestAnimationFrame(handleInput);
      });

      setInterval(syncOutput, 100);

      // 复制按钮：修复安卓/华为设备复制错位问题
      const copyBtn = document.getElementById('copyBtn');
      copyBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (e.stopPropagation) e.stopPropagation();
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();

        // 忽略当前选区，只复制输出区内容
        try { const sel0 = window.getSelection(); if (sel0) sel0.removeAllRanges(); } catch(_) {}

        const pv = viewOutput;
        const html = (pv && pv.innerHTML) || '';
        const text = (pv && pv.innerText) || '';
        const animate = () => { copyBtn.classList.add('flash'); setTimeout(()=>copyBtn.classList.remove('flash'), 280); };
        
        try {
          if (navigator.clipboard && window.ClipboardItem) {
            const data = { 'text/plain': new Blob([text], { type: 'text/plain' }) };
            if (html) data['text/html'] = new Blob([html], { type: 'text/html' });
            const item = new ClipboardItem(data);
            navigator.clipboard.write([item]).then(animate).catch(() => {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(animate).catch(() => {
                  // 退化一：选中输出区 + execCommand('copy')（有机会保留 HTML）
                  try {
                    const sel = window.getSelection();
                    const saved = [];
                    if (sel && sel.rangeCount) { for (let i=0;i<sel.rangeCount;i++) saved.push(sel.getRangeAt(i).cloneRange()); }
                    const r = document.createRange();
                    r.selectNodeContents(pv);
                    sel.removeAllRanges();
                    sel.addRange(r);
                    pv.focus();
                    allowProgrammaticCopy = true;
                    document.execCommand('copy');
                    allowProgrammaticCopy = false;
                    sel.removeAllRanges();
                    for (const rr of saved) sel.addRange(rr);
                    animate();
                  } catch(_) {
                    // 退化二：隐藏文本域 + execCommand('copy')
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.setAttribute('readonly','');
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    allowProgrammaticCopy = true;
                    try { document.execCommand('copy'); } catch(_) {} finally { allowProgrammaticCopy = false; }
                    document.body.removeChild(ta);
                    animate();
                  }
                });
              } else {
                // 无 writeText：直接尝试选中输出区复制
                try {
                  const sel = window.getSelection();
                  const saved = [];
                  if (sel && sel.rangeCount) { for (let i=0;i<sel.rangeCount;i++) saved.push(sel.getRangeAt(i).cloneRange()); }
                  const r = document.createRange();
                  r.selectNodeContents(pv);
                  sel.removeAllRanges();
                  sel.addRange(r);
                  pv.focus();
                  allowProgrammaticCopy = true;
                  document.execCommand('copy');
                  allowProgrammaticCopy = false;
                  sel.removeAllRanges();
                  for (const rr of saved) sel.addRange(rr);
                  animate();
                } catch(_) {
                  const ta = document.createElement('textarea');
                  ta.value = text;
                  ta.setAttribute('readonly','');
                  ta.style.position = 'fixed';
                  ta.style.left = '-9999px';
                  document.body.appendChild(ta);
                  ta.select();
                  allowProgrammaticCopy = true;
                  try { document.execCommand('copy'); } catch(_) {} finally { allowProgrammaticCopy = false; }
                  document.body.removeChild(ta);
                  animate();
                }
              }
            });
          } else if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(animate).catch(() => {
              // 退化一：选中输出区 + execCommand('copy')
              try {
                const sel = window.getSelection();
                const saved = [];
                if (sel && sel.rangeCount) { for (let i=0;i<sel.rangeCount;i++) saved.push(sel.getRangeAt(i).cloneRange()); }
                const r = document.createRange();
                r.selectNodeContents(pv);
                sel.removeAllRanges();
                sel.addRange(r);
                pv.focus();
                allowProgrammaticCopy = true;
                document.execCommand('copy');
                allowProgrammaticCopy = false;
                sel.removeAllRanges();
                for (const rr of saved) sel.addRange(rr);
                animate();
              } catch(_) {
                // 退化二：隐藏文本域 + execCommand('copy')
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.setAttribute('readonly','');
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                allowProgrammaticCopy = true;
                try { document.execCommand('copy'); } catch(_) {} finally { allowProgrammaticCopy = false; }
                document.body.removeChild(ta);
                animate();
              }
            });
          } else {
            // 最后退化：一次性 oncopy 写入 text/html 与 text/plain
            const onCopy = (ev) => {
              if (allowProgrammaticCopy && ev && ev.clipboardData) {
                ev.clipboardData.setData('text/plain', text);
                if (html) ev.clipboardData.setData('text/html', html);
                ev.preventDefault();
              }
            };
            document.addEventListener('copy', onCopy, true);
            allowProgrammaticCopy = true;
            try { document.execCommand('copy'); } catch(_) {} finally { allowProgrammaticCopy = false; document.removeEventListener('copy', onCopy, true); }
            animate();
          }
        } catch(_) {
          animate();
        }
      }, true);
      
      const clearBtn = document.getElementById('clearBtn');
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (hiddenInput) hiddenInput.value = '';
        if (hiddenOutput) hiddenOutput.value = '';
        if (viewOutput) viewOutput.innerText = '';
        el.innerHTML = '';
        el.focus();
        setCaretOffset(el, 0);
        clearBtn.classList.add('flash');
        setTimeout(()=>clearBtn.classList.remove('flash'), 280);
      });
    });
  </script>
  <script>
    // 康巴仓，这是启动 PWA 桌面图标的关键脚本
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW failed', err));
      });
    }
  </script>
</body>
</html>