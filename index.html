<!DOCTYPE html>
<html lang="bo">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>ཧི་མ་ལ་ཡ། >> པཎྜི་ཏ།</title>
  <style>
    @font-face { font-family: 'BZDHT'; src: url('./bzdht.ttf') format('truetype'); }
    @font-face { font-family: 'WildYak'; src: url('./TibetWildYak.ttf') format('truetype'); }

    :root { --primary-red: #8B0000; --bg: #f2f2f7; --card: #ffffff; --radius: 20px; }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); overflow: hidden; }

    body {
      font-family: 'WildYak', -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      padding: env(safe-area-inset-top) 12px calc(env(safe-area-inset-bottom) + 25px);
      gap: 6px;
    }

    .title-area { flex: 0 0 auto; padding: 2px 0; text-align: center; }
    .title-area h1 { font-size: clamp(14px, 4.5vw, 22px); color: var(--primary-red); margin: 0; font-family: 'WildYak'; }

    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      gap: 6px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid #d1d1d6;
      border-top: 6px solid var(--primary-red);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 8px;
    }

    .main-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
      overflow-y: auto;
    }

    .areas { display: grid; grid-template-rows: 1fr 1fr; grid-template-columns: 1fr; gap: 6px; flex: 1; min-height: 0; height: 100%; align-items: stretch; }
    .area { min-height: 0; min-width: 0; display: flex; flex-direction: column; overflow: hidden; }
    .area h2 { font-size: 11px; color: var(--primary-red); margin: 0 0 2px 0; font-family: 'WildYak'; }

    .preview {
      flex: 1;
      width: 100%;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid #e5e5ea;
      background: #ffffff;
      line-height: 1.28;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 0;
      overflow-y: auto;
    }

    #inputRich { font-family: 'WildYak', sans-serif !important; font-size: 18.8px; line-height: 1.664 !important; }
    #preview { font-size: 13.5px; line-height: 2.05; }
    #labelInput, #labelOutput { -webkit-user-select: none; user-select: none; }
    #preview .seg-cn { font-family: "Heiti SC","PingFang SC","Microsoft YaHei","Noto Sans SC",system-ui,sans-serif !important; }
    #preview .seg-bz, 
    #preview .seg-ti { font-family: 'BZDHT', sans-serif !important; }

    .preview[data-placeholder]:empty::before {
      content: attr(data-placeholder);
      color: #8e8e93;
      font-family: 'WildYak', serif !important;
      font-size: 18px !important;
      font-style: normal;
      pointer-events: none;
    }
    .preview[contenteditable][data-placeholder]:focus::before { content: none; }

    .toolbar-card { flex: 0 0 auto; display: flex; justify-content: center; gap: 15px; padding: 4px 0; }
    .btn { padding: 6px 20px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; font-family: 'WildYak'; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .btn-clear { background: #e5e5ea; color: #3a3a3c; }
    .btn-copy { background: var(--primary-red); color: white; }
    .btn svg { width: 18px; height: 18px; fill: currentColor; }
    .title-area, .toolbar-card, .footer-area { -webkit-user-select: none; user-select: none; }
    #inputRich, #preview { -webkit-user-select: text; user-select: text; -webkit-touch-callout: default; touch-action: manipulation; }
    .btn-blink { animation: btnBlink 450ms ease-in-out 1; }
    @keyframes btnBlink {
      0% { box-shadow: 0 0 0 0 rgba(139,0,0,0); transform: translateY(0); }
      30% { box-shadow: 0 0 0 4px rgba(139,0,0,0.25); transform: translateY(1px); }
      100% { box-shadow: 0 0 0 0 rgba(139,0,0,0); transform: translateY(0); }
    }
    #inputRich:focus, #inputRich:focus-visible { outline: none !important; box-shadow: none !important; -webkit-box-shadow: none !important; }

    .footer-area {
      flex: 0 0 auto;
      text-align: center;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(209, 209, 214, 0.4);
      margin-bottom: 5px;
    }

    .footer-area .disclaimer { color: var(--primary-red); font-size: 9px; line-height: 1.3; margin-bottom: 2px; font-family: sans-serif; }
    .footer-area .copyright { color: #007AFF; font-size: 9px; font-family: 'WildYak', serif; font-weight: bold; }

    @media (orientation: landscape) {
      .areas { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; height: 100%; }
      .title-area h1 { font-size: 14px; }
    }
    .ctx-menu{position:fixed;z-index:9999;background:#fff;border:1px solid #d1d1d6;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.12);min-width:140px;display:none;overflow:hidden}
    .ctx-menu.show{display:block}
    .ctx-item{padding:8px 12px;font-size:14px;color:#1c1c1e;cursor:pointer;display:flex;align-items:center;gap:8px}
    .ctx-item:hover{background:#f2f2f7}
    .ctx-item.disabled{opacity:.45;pointer-events:none}
    .ctx-divider{height:1px;background:#e5e5ea;margin:4px 0}
  </style>
  <script>
    if ('FontFace' in window) {
      var bzdFont = new FontFace('BZDHT', 'url(./bzdht.ttf)');
      bzdFont.load().then(function(loaded) {
        document.fonts.add(loaded);
        document.documentElement.classList.add('bzd-loaded');
      }).catch(function(e) { console.error('Font load failed:', e); });
    }
  </script>
</head>
<body class="mode-h2b">
  <div class="app">
    <div class="title-area">
      <h1>ཁམས་པ་ཚང་བོད་ཡིག་ཨང་བསྒྱུར། • ཧི་མ་ལ་ཡ། >> པཎྜི་ཏ།</h1>
    </div>

    <div class="main-container">
      <div class="card main-card">
        <div class="areas">
          <section class="area">
            <h2 id="labelInput">འགོད་འཇུག་ཁུལ།（ཧི་མ་ལ་ཡ།）</h2>
            <div id="inputRich" class="preview" contenteditable="true" aria-label="input" data-placeholder="ཧི་ཡིག་ནང་དོན་འདི་ན་འགོད་རོགས།..."></div>
          </section>
          <section class="area">
            <h2 id="labelOutput">མཇུག་འབྲས་ཁུལ།（པཎྚི་ཏ།）</h2>
            <div id="preview" class="preview" tabindex="0" data-placeholder="བསྒྱུར་ཟིན་པཎྚི་ཏ་འདི་ནས་འཆར་འོང་།"></div>
          </section>
        </div>
      </div>

      <div class="card toolbar-card">
        <button id="clearBtn" class="btn btn-clear" onclick="document.getElementById('inputRich').innerHTML='';document.getElementById('preview').textContent='';">
          གཙང་སེལ་བཟོ།
          <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        </button>
        <button id="copyBtn" class="btn btn-copy">
          ཆ་ཚང་བཤུ།
          <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
        </button>
      </div>
    </div>

    <div class="footer-area">
      <div class="disclaimer">免责声明：本软件按“现状”（AS IS）提供，仅限喜马拉雅与班智达藏文的编码转换。开发者不提供任何明示或暗示担保，亦不承担因使用本工具产生的任何直接或间接损失及法律责任。</div>
      <div class="copyright">© ༢༠༢༦ ཁམས་པ་ཚང་། KHAM PA TSANG ༡༧༧༡༡༩༥༥༥༥༤</div>
    </div>
  </div>
  <script src="./rules_data.js" defer></script>
  <script src="./converter.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var clipboardGranted = false;
      try {
        if (navigator.permissions && navigator.permissions.query) {
          navigator.permissions.query({ name: 'clipboard-read' }).then(function(p){
            clipboardGranted = (p && p.state === 'granted');
            if (p && 'onchange' in p) { p.onchange = function(){ clipboardGranted = (p.state === 'granted'); }; }
          }).catch(function(){});
        }
      } catch(_) {}
      var el = document.getElementById('inputRich');
      if (!el) return;
      ['inputRich','preview'].forEach(function(id){
        var t = document.getElementById(id);
        if (!t) return;
        t.addEventListener('contextmenu', function(e){
          activeTarget = t;
        });
      });
      // 彻底移除所有自定义粘贴监听，只保留浏览器原生行为
      // el.addEventListener('paste', function(e) { ... }); 
      
      // 如果需要处理粘贴后的内容，使用 input 事件即可
      el.addEventListener('input', function() {
        var walker = document.createTreeWalker(el, NodeFilter.SHOW_ELEMENT, null);
        var nodes = [];
        while (walker.nextNode()) nodes.push(walker.currentNode);
        nodes.forEach(function(n) {
          n.removeAttribute('style');
          if (n.nodeName === 'FONT') {
            while (n.firstChild) n.parentNode.insertBefore(n.firstChild, n);
            n.parentNode.removeChild(n);
          }
        });
        if (window.__runConvert) window.__runConvert();
      });

      function inlineEssentialStyles(root) {
        var walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
        var nodeList = [root];
        while (walker.nextNode()) nodeList.push(walker.currentNode);
        nodeList.forEach(function(node) {
          var cs = window.getComputedStyle(node);
          var styles = [];
          if (cs.whiteSpace) styles.push('white-space:' + cs.whiteSpace);
          if (cs.fontFamily) styles.push('font-family:' + cs.fontFamily);
          if (cs.fontSize) styles.push('font-size:' + cs.fontSize);
          if (cs.lineHeight) styles.push('line-height:' + cs.lineHeight);
          if (cs.fontWeight) styles.push('font-weight:' + cs.fontWeight);
          if (cs.textAlign && cs.textAlign !== 'start') styles.push('text-align:' + cs.textAlign);
          if (styles.length) node.setAttribute('style', styles.join(';'));
        });
      }

      function copyOutput() {
        var preview = document.getElementById('preview');
        if (!preview) return;

        // 1. Clear selection first
        try { window.getSelection().removeAllRanges(); } catch(_) {}

        var clone = preview.cloneNode(true);
        inlineEssentialStyles(clone);
        var html = '<div>' + clone.innerHTML + '</div>';
        var plain = preview.innerText || preview.textContent;

        var animate = function() {
          var btn = document.getElementById('copyBtn');
          if(btn) {
            btn.classList.remove('btn-blink');
            void btn.offsetWidth;
            btn.classList.add('btn-blink');
          }
        };

        var doExecCommand = function() {
          var didCopy = false;
          try {
            var sel = window.getSelection();
            var range = document.createRange();
            range.selectNodeContents(preview);
            sel.removeAllRanges();
            sel.addRange(range);
            window.__allowCopyOnce = true;
            didCopy = document.execCommand('copy');
            sel.removeAllRanges();
          } catch(e) {}
          
          if (!didCopy) {
            var ta = document.createElement('textarea');
            ta.value = plain;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            ta.setSelectionRange(0, plain.length);
            try {
              window.__allowCopyOnce = true;
              document.execCommand('copy');
            } catch(e) {}
            document.body.removeChild(ta);
          }
          animate();
        };

        if (navigator.clipboard && window.ClipboardItem) {
          try {
            var item = new ClipboardItem({
              'text/plain': new Blob([plain], { type: 'text/plain' }),
              'text/html': new Blob([html], { type: 'text/html' })
            });
            navigator.clipboard.write([item]).then(animate).catch(function() {
              if (navigator.clipboard.writeText) {
                navigator.clipboard.writeText(plain).then(animate).catch(doExecCommand);
              } else {
                doExecCommand();
              }
            });
          } catch(e) {
            if (navigator.clipboard.writeText) {
              navigator.clipboard.writeText(plain).then(animate).catch(doExecCommand);
            } else {
              doExecCommand();
            }
          }
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(plain).then(animate).catch(doExecCommand);
        } else {
          doExecCommand();
        }
      }

      var copyBtn = document.getElementById('copyBtn');
      if (copyBtn){
        copyBtn.addEventListener('click', function(ev){
          ev.preventDefault();
          ev.stopPropagation();
          if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
          
          copyOutput();
          
          // 动画已移至 copyOutput 内部，确保成功后才闪烁
        }, true);
      }
      var clearBtn = document.getElementById('clearBtn');
      if (clearBtn){
        clearBtn.addEventListener('click', function(){
          clearBtn.classList.remove('btn-blink');
          void clearBtn.offsetWidth;
          clearBtn.classList.add('btn-blink');
        });
      }

      function selectAllIn(el) {
        if (!el) return;
        var sel = window.getSelection();
        var range = document.createRange();
        range.selectNodeContents(el);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      var previewEl = document.getElementById('preview');
      if (previewEl) {
        previewEl.addEventListener('keydown', function(e) {
          if ((e.metaKey || e.ctrlKey) && (e.key === 'a' || e.key === 'A')) {
            e.preventDefault();
            selectAllIn(previewEl);
          }
        });
        previewEl.addEventListener('dblclick', function() {
          selectAllIn(previewEl);
        });
      }
      function within(node, container){
        if (!node || !container) return false;
        if (node === container) return true;
        var elNode = (node.nodeType === 1) ? node : node.parentNode;
        return container.contains(elNode);
      }
      function selectionAllowed(){
        var sel = window.getSelection();
        if (!sel || sel.rangeCount===0) return false;
        var ir = document.getElementById('inputRich');
        var pv = document.getElementById('preview');
        for (var i=0;i<sel.rangeCount;i++){
          var r = sel.getRangeAt(i);
          var sc = r.startContainer;
          var ec = r.endContainer;
          var inInput = within(sc, ir) && within(ec, ir);
          var inPreview = within(sc, pv) && within(ec, pv);
          if (!(inInput || inPreview)) return false;
        }
        return true;
      }
      (function(){
        var adjusting = false;
        document.addEventListener('selectionchange', function(){
          if (adjusting) return;
          var sel = window.getSelection();
          if (!sel || sel.rangeCount===0) return;
          var ir = document.getElementById('inputRich');
          var pv = document.getElementById('preview');
          var cross = false;
          for (var i=0;i<sel.rangeCount;i++){
            var r = sel.getRangeAt(i);
            var sc = r.startContainer;
            var ec = r.endContainer;
            var scEl = (sc && sc.nodeType===1) ? sc : (sc ? sc.parentNode : null);
            var ecEl = (ec && ec.nodeType===1) ? ec : (ec ? ec.parentNode : null);
            var inInput = scEl && ecEl && ir.contains(scEl) && ir.contains(ecEl);
            var inPreview = scEl && ecEl && pv.contains(scEl) && pv.contains(ecEl);
            if (!(inInput || inPreview)) { cross = true; break; }
          }
          if (!cross) return;
          adjusting = true;
          try {
            var an = sel.anchorNode;
            var anEl = (an && an.nodeType===1) ? an : (an ? an.parentNode : null);
            var target = null;
            if (anEl && ir.contains(anEl)) target = ir;
            else if (anEl && pv.contains(anEl)) target = pv;
            if (target){
              var range = document.createRange();
              range.selectNodeContents(target);
              sel.removeAllRanges();
              sel.addRange(range);
            } else {
              sel.removeAllRanges();
            }
          } finally {
            adjusting = false;
          }
        });
      })();
      document.addEventListener('copy', function(e){
        if (window.__allowCopyOnce){ window.__allowCopyOnce = false; return; }
        if (!selectionAllowed()){
          e.preventDefault();
        }
      }, true);
      if (window.__runConvert) window.__runConvert();
      
      var menu = document.createElement('div');
      menu.className = 'ctx-menu';
      function mk(text,id){ var d=document.createElement('div'); d.className='ctx-item'; d.textContent=text; d.dataset.id=id; return d; }
      var itemPaste = mk('粘贴','paste');
      var itemCopy = mk('复制','copy');
      var itemCut = mk('剪切','cut');
      var itemSelAll = mk('全选','select_all');
      var divLine = document.createElement('div'); divLine.className='ctx-divider';
      menu.appendChild(itemPaste); menu.appendChild(itemCopy); menu.appendChild(itemCut); menu.appendChild(divLine); menu.appendChild(itemSelAll);
      document.body.appendChild(menu);
      var activeTarget = null;
      var lastMenuX = 0, lastMenuY = 0;
      function showMenu(x,y,t){
        activeTarget = t; lastMenuX=x; lastMenuY=y;
        var editable = !!(t && t.isContentEditable);
        itemCut.classList.toggle('disabled', !editable);
        itemPaste.classList.toggle('disabled', !editable);
        var vw = window.innerWidth, vh = window.innerHeight;
        menu.style.left = Math.min(x, vw - menu.offsetWidth - 4) + 'px';
        menu.style.top  = Math.min(y, vh - menu.offsetHeight - 4) + 'px';
        menu.classList.add('show');
      }
      function hideMenu(){ menu.classList.remove('show'); activeTarget=null; }
      function selectAllInNode(node){
        if (!node) return;
        var sel = window.getSelection();
        var range = document.createRange();
        range.selectNodeContents(node);
        sel.removeAllRanges();
        sel.addRange(range);
      }
      function selectionWithinNode(node){
        var sel = window.getSelection();
        if (!sel || sel.rangeCount===0) return false;
        for (var i=0;i<sel.rangeCount;i++){
          var r = sel.getRangeAt(i);
          var sc = r.startContainer.nodeType===1 ? r.startContainer : r.startContainer.parentNode;
          var ec = r.endContainer.nodeType===1 ? r.endContainer : r.endContainer.parentNode;
          if (!(node.contains(sc) && node.contains(ec))) return false;
        }
        return true;
      }
      function getPasteTarget(){
        var t = activeTarget;
        if (!t || !(t.nodeType)) {
          t = document.getElementById('inputRich');
          if (!t || !t.isContentEditable) t = document.getElementById('preview');
          if (!t || !t.isContentEditable) t = document.activeElement;
        }
        return t && t.nodeType ? t : null;
      }
      
      document.addEventListener('click', hideMenu);
      document.addEventListener('scroll', hideMenu, true);
      var pasteOverlay = document.createElement('div');
      pasteOverlay.style.position = 'fixed';
      pasteOverlay.style.zIndex = '10000';
      pasteOverlay.style.background = '#fff';
      pasteOverlay.style.border = '1px solid #d1d1d6';
      pasteOverlay.style.borderRadius = '8px';
      pasteOverlay.style.boxShadow = '0 6px 20px rgba(0,0,0,.12)';
      pasteOverlay.style.padding = '6px';
      pasteOverlay.style.display = 'none';
      var pasteBox = document.createElement('div');
      pasteBox.contentEditable = 'true';
      pasteBox.style.minWidth = '160px';
      pasteBox.style.minHeight = '24px';
      pasteBox.style.outline = 'none';
      var ctrl = document.createElement('div');
      ctrl.style.display = 'flex';
      ctrl.style.justifyContent = 'flex-end';
      ctrl.style.gap = '8px';
      ctrl.style.marginTop = '6px';
      var btnPaste = document.createElement('button');
      btnPaste.textContent = '粘贴';
      btnPaste.className = 'btn btn-copy';
      var btnCancel = document.createElement('button');
      btnCancel.textContent = '取消';
      btnCancel.className = 'btn btn-clear';
      pasteOverlay.appendChild(pasteBox);
      pasteOverlay.appendChild(ctrl);
      ctrl.appendChild(btnCancel);
      ctrl.appendChild(btnPaste);
      document.body.appendChild(pasteOverlay);
      function insertPlain(txt){
        var target = getPasteTarget();
        if (!target) return;
        var sel = window.getSelection();
        if (!sel || sel.rangeCount===0 || !selectionWithinNode(target)){
          var r0 = document.createRange();
          r0.selectNodeContents(target);
          r0.collapse(false);
          sel.removeAllRanges();
          sel.addRange(r0);
        }
        document.execCommand('insertText', false, txt);
        hidePasteOverlay();
        hideMenu();
        if (window.__runConvert) window.__runConvert();
      }
      function showPasteOverlay(){
        pasteOverlay.style.left = Math.min(lastMenuX, window.innerWidth - 200) + 'px';
        pasteOverlay.style.top  = Math.min(lastMenuY, window.innerHeight - 80) + 'px';
        pasteOverlay.style.display = 'block';
        pasteBox.textContent = '';
        pasteBox.focus();
        if (clipboardGranted && navigator.clipboard && navigator.clipboard.readText){
          navigator.clipboard.readText().then(function(txt){ if (txt) insertPlain(txt); }).catch(function(){});
        }
        try { document.execCommand('paste'); } catch(_){}
      }
      function hidePasteOverlay(){ pasteOverlay.style.display = 'none'; }
      btnCancel.addEventListener('click', function(){ hidePasteOverlay(); hideMenu(); });
      btnPaste.addEventListener('click', function(){
        var attemptFromBox = function(){
          var txt = pasteBox.textContent || '';
          if (txt) { insertPlain(txt); return true; }
          return false;
        };
        if (clipboardGranted && navigator.clipboard && navigator.clipboard.readText){
          navigator.clipboard.readText().then(function(txt){ if (txt) insertPlain(txt); else { pasteBox.focus(); setTimeout(function(){ attemptFromBox(); }, 50); } }).catch(function(){ pasteBox.focus(); try{ document.execCommand('paste'); }catch(_){} setTimeout(function(){ attemptFromBox(); }, 50); });
        } else {
          pasteBox.focus();
          try { document.execCommand('paste'); } catch(_){}
          setTimeout(function(){ attemptFromBox(); }, 50);
        }
      });
      pasteBox.addEventListener('paste', function(e){
        e.preventDefault();
        var txt = (e.clipboardData || window.clipboardData).getData('text/plain') || '';
        if (txt) insertPlain(txt);
      });
      pasteBox.addEventListener('input', function(){
        var txt = pasteBox.textContent || '';
        if (txt) insertPlain(txt);
      });
      pasteBox.addEventListener('beforeinput', function(e){
        if (e.inputType==='insertFromPaste'){
          var txt = e.data || '';
          if (txt) insertPlain(txt);
          e.preventDefault();
        }
      });
      document.addEventListener('keydown', function(ev){ if (ev.key==='Escape') hidePasteOverlay(); }, true);
      menu.addEventListener('click', function(e){
        var id = e.target && e.target.dataset ? e.target.dataset.id : null;
        if (!id || !activeTarget) return;
        if (id==='select_all'){ selectAllInNode(activeTarget); hideMenu(); return; }
        if (id==='copy'){
          if (!selectionWithinNode(activeTarget)) selectAllInNode(activeTarget);
          try { window.__allowCopyOnce = true; document.execCommand('copy'); } catch(_) {}
          hideMenu();
          return;
        }
        if (id==='cut'){
          if (!activeTarget.isContentEditable) return;
          if (!selectionWithinNode(activeTarget)) selectAllInNode(activeTarget);
          try { document.execCommand('cut'); } catch(_) {}
          hideMenu();
          if (activeTarget.id==='inputRich'){ if (window.__runConvert) window.__runConvert(); }
          return;
        }
        if (id==='paste'){
          var target = getPasteTarget();
          if (!target || !target.isContentEditable) return;
          var tryExecPaste = function(){
            try {
              if (!selectionWithinNode(target)) selectAllInNode(target);
              target.focus();
              document.execCommand('paste');
              hideMenu();
              if (window.__runConvert) window.__runConvert();
            } catch(_){}
          };
          var pastedHTML = '', pastedText = '';
          var tmp = document.createElement('div');
          tmp.contentEditable = 'true';
          tmp.style.position = 'fixed';
          tmp.style.left = '-9999px';
          tmp.style.opacity = '0';
          document.body.appendChild(tmp);
          try {
            tmp.focus();
            document.execCommand('paste');
            pastedHTML = tmp.innerHTML || '';
            pastedText = tmp.textContent || '';
          } catch(_){}
          document.body.removeChild(tmp);
          if (pastedHTML && pastedHTML.trim().length){
            if (!selectionWithinNode(target)) selectAllInNode(target);
            document.execCommand('insertHTML', false, pastedHTML);
            hideMenu();
            if (window.__runConvert) window.__runConvert();
            return;
          }
          if (pastedText && pastedText.trim().length){
            insertPlain(pastedText);
            hideMenu();
            return;
          }
          tryExecPaste();
        }
      });
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then(function(reg){
        if (reg.waiting) { reg.waiting.postMessage({type:'SKIP_WAITING'}); }
        reg.addEventListener('updatefound', function(){
          var nw = reg.installing;
          if (!nw) return;
          nw.addEventListener('statechange', function(){
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
            }
          });
        });
      });
      var refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', function(){
        if (refreshing) return;
        refreshing = true;
        location.reload();
      });
    }
  </script>
</body>
</html>
